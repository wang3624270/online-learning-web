<template>
    <div v-loading.fullscreen.lock="loading">
        <header class="am-topbar am-topbar-inverse admin-header">
            <div class="am-topbar-brand">
                <router-link to="/index" class="tpl-logo">
                    <img src="./assets/img/logo.jpg" alt="">
                </router-link>
            </div>
            <div class="am-icon-list tpl-header-nav-hover-ico am-fl am-margin-right">

            </div>

            <button class="am-topbar-btn am-topbar-toggle am-btn am-btn-sm am-btn-success am-show-sm-only" data-am-collapse="{target: '#topbar-collapse'}"><span class="am-sr-only">å¯¼èˆªåˆ‡æ¢</span> <span class="am-icon-bars"></span></button>

            <div class="am-collapse am-topbar-collapse" id="topbar-collapse">

                <ul class="am-nav am-nav-pills am-topbar-nav am-topbar-right admin-header-list tpl-header-list">
                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="am-icon-bell-o"></span> æé†’ <span class="am-badge tpl-badge-success am-round">5</span>
                        </a>
                        <ul class="am-dropdown-content tpl-dropdown-content">
                            <li class="tpl-dropdown-content-external">
                                <h3>ä½ æœ‰ <span class="tpl-color-success">5</span> æ¡æé†’</h3><a href="###">å…¨éƒ¨</a></li>
                            <li class="tpl-dropdown-list-bdbc"><a href="#" class="tpl-dropdown-list-fl"><span class="am-icon-btn am-icon-plus tpl-dropdown-ico-btn-size tpl-badge-success"></span> ã€é¢„è§ˆæ¨¡å—ã€‘ç§»åŠ¨ç«¯ æŸ¥çœ‹æ—¶ æ‰‹æœºã€ç”µè„‘æ¡†éšè—ã€‚</a>
                                <span class="tpl-dropdown-list-fr">3å°æ—¶å‰</span>
                            </li>
                            <li class="tpl-dropdown-list-bdbc"><a href="#" class="tpl-dropdown-list-fl"><span class="am-icon-btn am-icon-check tpl-dropdown-ico-btn-size tpl-badge-danger"></span> ç§»åŠ¨ç«¯ï¼Œå¯¼èˆªæ¡ä¸‹è¾¹è·å¤„ç†</a>
                                <span class="tpl-dropdown-list-fr">15åˆ†é’Ÿå‰</span>
                            </li>
                            <li class="tpl-dropdown-list-bdbc"><a href="#" class="tpl-dropdown-list-fl"><span class="am-icon-btn am-icon-bell-o tpl-dropdown-ico-btn-size tpl-badge-warning"></span> è¿½åŠ ç»Ÿè®¡ä»£ç </a>
                                <span class="tpl-dropdown-list-fr">2å¤©å‰</span>
                            </li>
                        </ul>
                    </li>
                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="am-icon-comment-o"></span> æ¶ˆæ¯ <span class="am-badge tpl-badge-danger am-round">9</span>
                        </a>
                        <ul class="am-dropdown-content tpl-dropdown-content">
                            <li class="tpl-dropdown-content-external">
                                <h3>ä½ æœ‰ <span class="tpl-color-danger">9</span> æ¡æ–°æ¶ˆæ¯</h3><a href="###">å…¨éƒ¨</a></li>
                            <li>
                                <a href="#" class="tpl-dropdown-content-message">
                                <span class="tpl-dropdown-content-photo">
                      <img src="./assets/img/user02.png" alt=""> </span>
                                    <span class="tpl-dropdown-content-subject">
                      <span class="tpl-dropdown-content-from"> ç¦è¨€å°å¼  </span>
                                <span class="tpl-dropdown-content-time">10åˆ†é’Ÿå‰ </span>
                                </span>
                                    <span class="tpl-dropdown-content-font"> Amaze UI çš„è¯ç”Ÿï¼Œä¾æ‰˜äº GitHub åŠå…¶ä»–æŠ€æœ¯ç¤¾åŒºä¸Šä¸€äº›ä¼˜ç§€çš„èµ„æºï¼›Amaze UI çš„æˆé•¿ï¼Œåˆ™ç¦»ä¸å¼€ç”¨æˆ·çš„æ”¯æŒã€‚ </span>
                                </a>
                                <a href="#" class="tpl-dropdown-content-message">
                                <span class="tpl-dropdown-content-photo">
                      <img src="./assets/img/user03.png" alt=""> </span>
                                    <span class="tpl-dropdown-content-subject">
                      <span class="tpl-dropdown-content-from"> Steam </span>
                                <span class="tpl-dropdown-content-time">18åˆ†é’Ÿå‰</span>
                                </span>
                                    <span class="tpl-dropdown-content-font"> ä¸ºäº†èƒ½æœ€å‡†ç¡®çš„ä¼ è¾¾æ‰€æè¿°çš„é—®é¢˜ï¼Œ å»ºè®®ä½ åœ¨åé¦ˆæ—¶é™„ä¸Šæ¼”ç¤ºï¼Œæ–¹ä¾¿æˆ‘ä»¬ç†è§£ã€‚ </span>
                                </a>
                            </li>

                        </ul>
                    </li>
                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="am-icon-calendar"></span> è¿›åº¦ <span class="am-badge tpl-badge-primary am-round">4</span>
                        </a>
                        <ul class="am-dropdown-content tpl-dropdown-content">
                            <li class="tpl-dropdown-content-external">
                                <h3>ä½ æœ‰ <span class="tpl-color-primary">4</span> ä¸ªä»»åŠ¡è¿›åº¦</h3><a href="###">å…¨éƒ¨</a></li>
                            <li>
                                <a href="javascript:;" class="tpl-dropdown-content-progress">
                                <span class="task">
                        <span class="desc">Amaze UI ç”¨æˆ·ä¸­å¿ƒ v1.2 </span>
                                <span class="percent">45%</span>
                                </span>
                                    <span class="progress">
                        <div class="am-progress tpl-progress am-progress-striped"><div class="am-progress-bar am-progress-bar-success" style="width:45%"></div></div>
                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="javascript:;" class="tpl-dropdown-content-progress">
                                <span class="task">
                        <span class="desc">æ–°é—»å†…å®¹é¡µ </span>
                                <span class="percent">30%</span>
                                </span>
                                    <span class="progress">
                       <div class="am-progress tpl-progress am-progress-striped"><div class="am-progress-bar am-progress-bar-secondary" style="width:30%"></div></div>
                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="javascript:;" class="tpl-dropdown-content-progress">
                                <span class="task">
                        <span class="desc">ç®¡ç†ä¸­å¿ƒ </span>
                                <span class="percent">60%</span>
                                </span>
                                    <span class="progress">
                        <div class="am-progress tpl-progress am-progress-striped"><div class="am-progress-bar am-progress-bar-warning" style="width:60%"></div></div>
                    </span>
                                </a>
                            </li>

                        </ul>
                    </li>
                    <li class="am-hide-sm-only"><a href="javascript:;" id="admin-fullscreen" class="tpl-header-list-link"><span class="am-icon-arrows-alt"></span> <span class="admin-fullText">å¼€å¯å…¨å±</span></a></li>

                    <li class="am-dropdown" data-am-dropdown data-am-dropdown-toggle>
                        <a class="am-dropdown-toggle tpl-header-list-link" href="javascript:;">
                            <span class="tpl-header-list-user-nick">{{perName}}</span><span class="tpl-header-list-user-ico"> <img src="./assets/img/user.png"></span>
                        </a>
                        <ul class="am-dropdown-content">
                            <li><a href="#"><span class="am-icon-bell-o"></span> èµ„æ–™</a></li>
                            <li><a href="#"><span class="am-icon-cog"></span> è®¾ç½®</a></li>
                            <li><a href="#" @click="logout"><span class="am-icon-power-off"></span> é€€å‡º</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </header>

        <div class="tpl-page-container tpl-page-header-fixed">

            <div class="tpl-left-nav tpl-left-nav-hover">
                <div class="tpl-left-nav-title">
                    {{groupName}}
                </div>
                <div class="tpl-left-nav-list">
                    <ul class="tpl-left-nav-menu">
                        <li class="tpl-left-nav-item" @click="clearMenu">
                            <router-link to="/index" class="nav-link">
                                <i class="am-icon-home"></i>
                                <span>é¦–é¡µ</span>
                            </router-link>
                        </li>
                        <li class="tpl-left-nav-item" v-for="(item,index1) in navItems">
                            <a class="nav-link tpl-left-nav-link-list">
                                <i :class="item.icon"></i>
                                <span>{{item.label}}</span>
                                <i class="am-icon-angle-right tpl-left-nav-more-ico am-fr am-margin-right tpl-left-nav-more-ico-rotate"></i>
                            </a>
                            <ul @click="selectMenu(index1,index2)" class="tpl-left-nav-sub-menu" style="display: block;" v-for="(subItem,index2) in item.children">
                                <li>
                                    <router-link :to="subItem.path" name="second-level" :class="subItem.style">
                                        <i class="am-icon-angle-right"></i>
                                        <span>{{subItem.label}}</span>
                                    </router-link>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="tpl-content-wrapper">
                <div class="tpl-portlet-components" style="min-height: 600px;">
                    <router-view></router-view>
                </div>
            </div>

        </div>
    </div>
</template>
<script>
    import './assets/css/common.css';
    import './assets/css/amazeui.min.css';
    import './assets/css/admin.css';
    import './assets/css/app.css';
    import { iscroll } from'./assets/js/iscroll.js';
    import { app } from'./assets/js/app.js';
    import navItems from './navItems';
    import AmazeUI  from 'amazeui';
    import LoginInterface from '@/interfaces/loginInterface';
    import ManageInterface from '@/interfaces/manageInterface';

    export default {
        data () {
            return {
                perName:'',
                groupName:'',
                navItems:[],
                clearHighlightItem:null,
                lastIndex1:null,
                lastIndex2:null,
                loading:false
            }
        },
        beforeMount(){
            this.loading=true;
            this.initMenu();
            this.initPersonInfo();
        },
        mounted(){
            iscroll(window, document, Math);
        },
        methods:{
            initPersonInfo(){
                ManageInterface.getPersonInfo({}).then( (res) => {
                    if (res.re == ManageInterface.SUCCESS) {
                        let data=res.data;
                        this.groupName=data.groupName;
                        this.perName=data.perName;
                    } else {
                        this.$message.error(`å‡ºé”™å•¦ã€${res.data}ã€‘ï¼Œè¯·ç¨åé‡è¯•ï¼ğŸ˜…`);
                    }
                });
            },
            initMenu(){
                LoginInterface.initMenu({}).then( (res) => {
                    if (res.re == LoginInterface.SUCCESS) {
                        let menus=[];
                        let pathList=[];
                        let data=res.data;
                        let menuList=data.menuList;
                        for(let i=0;i<menuList.length;i++){
                            pathList.push(menuList[i].path);
                        }
                        for(let i=0;i<navItems.length;i++){
                            let items=navItems[i];
                            let children=[];
                            let subItems=items.children;
                            for(let j=0;j<subItems.length;j++){
                                let subItem=subItems[j];
                                if(pathList.indexOf(subItem.path)!=-1){
                                    subItem.style='';
                                    children.push(subItem);
                                }
                            }
                            if(children.length>0){
                                items.children=children;
                                menus.push(items);
                            }
                        }
                        this.navItems=menus;
                    } else {
                        window.location.href='/';
                    }
                }).then(()=> {
                    app();
                    this.loading=false;
                });
            },
            selectMenu(index1,index2){
                this.clearMenu();
                this.navItems[index1].children[index2].style='select-menu';
                this.lastIndex1=index1;
                this.lastIndex2=index2;
            },
            clearMenu(){
                if(this.lastIndex1!=null){
                    this.navItems[this.lastIndex1].children[this.lastIndex2].style='';
                }
            },
            logout(){
                this.loading=true;
                LoginInterface.doLogout({}).then( (res) => {
                    this.loading=false;
                    if (res.reCode == LoginInterface.SUCCESS_CODE) {
                        window.location.href='/';
                    } else {
                        this.$message.error(`å‡ºé”™å•¦ã€${res.data}ã€‘ï¼Œè¯·ç¨åé‡è¯•ï¼ğŸ˜…`);
                    }
                });
            }
        }
    }
</script>
<style scoped>
    .select-menu{
        border-left: 3px solid #5C9ACF!important;
        background: #f2f6f9;
        margin-left: -3px;
    }
</style>
